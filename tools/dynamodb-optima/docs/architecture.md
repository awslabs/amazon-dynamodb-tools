
# Architecture

← [Documentation Index](README.md) | [Main README](../README.md)

---

## System Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                      CLI / GUI Layer                         │
│  (commands, Streamlit dashboard, interactive analysis)      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    Business Logic Layer                      │
│  • Discovery (multi-account, cross-region)                  │
│  • Collection (metrics, pricing, CUR)                       │
│  • Analysis (capacity, table class, utilization)            │
│  • State Management (checkpoints, resume)                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Data Access Layer                          │
│  • DuckDB Connection Pool                                    │
│  • OLAP-Optimized Queries                                    │
│  • Schema Management & Migrations                            │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   External Services                          │
│  AWS Organizations • CloudWatch • Pricing API • S3 (CUR)    │
└─────────────────────────────────────────────────────────────┘
```

### Database Schema

**Core Tables:**

- **`table_metadata`** - Discovered DynamoDB tables
  - Primary Key: `(account_id, table_name, region)`
  - Stores: Table configuration, billing mode, table class, provisioned capacity, size, GSI/LSI definitions, tags, encryption, PITR status
  - Updated during: `discover` command

- **`gsi_metadata`** - Global Secondary Indexes
  - Primary Key: `(account_id, region, table_name, gsi_name)`
  - Stores: GSI provisioned capacity, projection type, resource names for metrics collection
  - Index: `idx_gsi_resource_name` for efficient metrics lookups

- **`metrics`** - CloudWatch metrics (time-series data)
  - Primary Key: `(account_id, resource_name, metric_name, timestamp, statistic, period_seconds)`
  - Stores: Consumed/provisioned capacity, throttled requests, user errors, system errors (per table and GSI)
  - Indexes: Optimized for time-range queries and operation analysis
  - Updated during: `collect` command

- **`pricing_data`** - AWS Pricing API data
  - Primary Key: `pricing_id`
  - Stores: Per-region DynamoDB SKUs including tiered pricing (free tier), On-Demand/Provisioned rates
  - Fields: `price_per_unit`, `begin_range`/`end_range` (for free tier), `usage_type`, `product_family`, `operation`
  - Indexes: By region, usage type, product family
  - Updated during: `discover` command

**Analysis Tables:**

- **`capacity_mode_recommendations`**
  - Stores: On-Demand vs Provisioned analysis results
  - Includes: Current/projected costs, autoscaling simulation results, utilization statistics, savings calculations
  - Generated by: `analyze-capacity` command

- **`table_class_recommendations`**
  - Stores: Standard vs Standard-IA analysis results
  - Includes: Storage-to-throughput ratios, breakeven analysis, CUR-based cost projections
  - Generated by: `analyze-table-class` command

- **`utilization_recommendations`**
  - Stores: Over-provisioning detection results
  - Includes: Current vs recommended capacity, utilization percentiles (avg, max, p99), risk assessment
  - Generated by: `analyze-utilization` command

**Operational Tables:**

- **`collection_state`** - Operation progress tracking
  - Stores: Operation type, status, progress percentage, current step, error messages

- **`checkpoints`** - Resume capability
  - Stores: Operation snapshots for resuming interrupted long-running operations

- **`aws_accounts`** - AWS Organizations accounts
  - Primary Key: `account_id`
  - Stores: Account metadata, organizational unit info, join status
  - Populated during: `discover --use-org` command

- **`cur_metadata`** - CUR discovery and configuration
  - Primary Key: `management_account_id`
  - Stores: CUR report details (S3 bucket/prefix, format, granularity, INCLUDE_RESOURCES status)
  - Auto-discovered during: `discover` command

- **`cur_data`** - Raw Cost & Usage Report line items
  - Primary Key: `(identity_line_item_id, identity_time_interval)`
  - Stores: Filtered DynamoDB usage from CUR (unblended costs, net costs, usage amounts, operations)
  - Indexes: By resource, account, region, month, operation, cost (DESC)
  - Collected during: `collect-cur` command

